import java.text.SimpleDateFormat
version = ""
imageName = "backend"
devTag = "0.0-0"
CICD_PROJECT = "ci-cd"
DEV_PROJECT = "dev"
selectTag = ""
releaseTag = ""
tag = ""
UAT_PROJECT = "uat"

node('dotnet-31') {

  stage('Checkout Source') {
	checkout scm
  }
  
  stage('Prepare Variable') {
	script {
	  def dateFormat = new SimpleDateFormat("yyyyMMdd")
      def date = new Date()
      def releaseDate = (dateFormat.format(date))
      tag = releaseDate + "-" + env.BUILD_NUMBER
	  echo "tag: ${tag}"
	}
  }

  stage('Choose UAT Version') {
    script {
      openshift.withCluster() {
        namespace = openshift.project()
        def tags = openshift.selector("istag")
          .objects()
          .collect {
            it.metadata.name
          }
          .findAll {
            it ==~ /^backend:([0-9]+)\.([0-9]+)\.([0-9]+)\-([0-9]+)$/
            //it.startsWith 'backend:([0-9]+)\.([0-9]+)\.([0-9]+)\-([0-9]+)'
          }
          .collect {
            it.replaceAll(/backend:(.*)/, "\$1")
          }
          .sort()
        timeout(5) {
          selectTag = input(
            ok: "Deploy UAT",
            message: "Enter release version to promote to UAT",
            parameters: [
              choice(
                choices: tags.join('\n'),
                description: '',
                name: 'Release Version'
              )
            ]
          )
        }
      }
      println "selectTag = ${selectTag}"
      version = selectTag.split('-')[0]
      println "version = ${version}"
      println "tag = ${tag}"
      releaseTag = version + "-" + tag
      println "releaseTag = ${releaseTag}"
    }
  }
}
